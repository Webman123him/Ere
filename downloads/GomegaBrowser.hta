<html>
<head>
  <title>Gomega Browser Launcher</title>
  <HTA:APPLICATION
    ID="GomegaBrowser" APPLICATIONNAME="Gomega Browser"
    BORDER="dialog" CAPTION="yes" SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes" SYSMENU="yes" SCROLL="no" WINDOWSTATE="normal">
<script language="VBScript">
Option Explicit

Dim g_version, g_versionCheckURL, g_updatePage
g_version = "16"
g_versionCheckURL = "https://gomega.watch/browser/version.txt"
g_updatePage = "https://gomega.watch/browser"

Dim g_chromePaths
g_chromePaths = Array( _
  "C:\Program Files\Google\Chrome\Application\chrome.exe", _
  "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" _
)

Dim g_gomegaExe
g_gomegaExe = "C:\Program Files\GomegaBrowser\GomegaBrowser.exe"

Dim g_r_url1, g_r_url2, g_r_url3, g_r_customUA
g_r_url1 = StrReverse("https://gomega.watch/v16")
g_r_url2 = StrReverse("https://gomega.watch/info")
g_r_url3 = StrReverse("https://gomega.watch/")
g_r_customUA = StrReverse("Mozilla/5.0 (X11; CrOS aarch64 13099.85.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.110 Safari/537.36 - Google Search")

Dim g_fso, g_shell
Set g_fso = CreateObject("Scripting.FileSystemObject")
Set g_shell = CreateObject("WScript.Shell")

Dim g_href, g_filePath, g_tf, g_fileContents
g_href = document.location.href
If Left(g_href,8) = "file:///" Then
  g_filePath = Mid(g_href,9)
ElseIf Left(g_href,7) = "file://" Then
  g_filePath = Mid(g_href,8)
Else
  g_filePath = g_href
End If
g_filePath = Replace(g_filePath, "/", "\")
g_filePath = Replace(g_filePath, "%20", " ")

On Error Resume Next
If g_fso.FileExists(g_filePath) Then
  Set g_tf = g_fso.OpenTextFile(g_filePath, 1, False)
  g_fileContents = g_tf.ReadAll
  g_tf.Close
Else
  g_fileContents = ""
End If
On Error GoTo 0

If g_fileContents = "" Then
  MsgBox "Integrity check failed.", vbCritical, "Error"
  window.close
End If

Dim url1, url2, url3, customUA
url1 = StrReverse(g_r_url1)
url2 = StrReverse(g_r_url2)
url3 = StrReverse(g_r_url3)
customUA = StrReverse(g_r_customUA)

Function FetchURLText(u)
  Dim xhr, resp
  On Error Resume Next
  Set xhr = CreateObject("MSXML2.ServerXMLHTTP.6.0")
  xhr.setTimeouts 5000,5000,10000,10000
  xhr.open "GET", u, False
  xhr.send
  resp = ""
  If Err.Number = 0 Then
    If xhr.Status = 200 Then resp = Trim(CStr(xhr.responseText))
  End If
  Set xhr = Nothing
  On Error GoTo 0
  FetchURLText = resp
End Function

Function CompareVersions(v1, v2)
  Dim a, b, i, n, x, y
  a = Split(Trim(CStr(v1)) & "", ".")
  b = Split(Trim(CStr(v2)) & "", ".")
  n = UBound(a)
  If UBound(b) > n Then n = UBound(b)
  For i = 0 To n
    If i <= UBound(a) Then x = CLng(Val(a(i))) Else x = 0
    If i <= UBound(b) Then y = CLng(Val(b(i))) Else y = 0
    If x > y Then CompareVersions = 1 : Exit Function
    If x < y Then CompareVersions = -1 : Exit Function
  Next
  CompareVersions = 0
End Function

Dim g_latestVersion
g_latestVersion = FetchURLText(g_versionCheckURL)
If g_latestVersion = "" Then
  MsgBox "Version check failed.", vbExclamation, "Error"
  window.close
End If

If Trim(CStr(g_latestVersion)) <> Trim(CStr(g_version)) Then
  MsgBox "Version mismatch download the new one." & vbCrLf & _
         "Installed: v" & g_version & vbCrLf & "Remote: v" & g_latestVersion, vbExclamation, "Error"
  window.close
End If

Dim g_chromePath, idx, candidate
g_chromePath = ""
For idx = 0 To UBound(g_chromePaths)
  candidate = g_chromePaths(idx)
  If g_fso.FileExists(candidate) Then
    g_chromePath = candidate
    Exit For
  End If
Next

If g_chromePath = "" Then
  If g_fso.FileExists(g_gomegaExe) Then g_chromePath = g_gomegaExe
End If

If g_chromePath = "" Then
  MsgBox "No supported browser found.", vbExclamation, "Error"
  window.close
End If

Dim keysText, keysArr, entered, found, normText
keysText = FetchURLText("https://gomega.watch/browser/codes.txt")
If keysText = "" Then
  MsgBox "Password fetch failed.", vbExclamation, "Error"
  window.close
End If

normText = keysText
normText = Replace(normText, vbCrLf, ",")
normText = Replace(normText, vbLf, ",")
normText = Replace(normText, vbCr, ",")
keysArr = Split(normText, ",")

entered = InputBox("Enter launcher password: (Buy one for $4)", "Authentication", "")
If entered = "" Then
  MsgBox "No password entered.", vbExclamation, "Error"
  window.close
End If

found = False
Dim iKey
For Each iKey In keysArr
  If Trim(iKey) = Trim(entered) Then
    found = True
    Exit For
  End If
Next

If Not found Then
  MsgBox "Authentication failed.", vbCritical, "Error"
  window.close
End If

On Error Resume Next
g_shell.Run "taskkill /IM chrome.exe /F", 0, True
On Error GoTo 0

Dim uaFlag, cmdLine
uaFlag = "--user-agent=" & """" & customUA & """"
cmdLine = """" & g_chromePath & """ " & uaFlag & " " & """" & url1 & """ " & """" & url2 & """ " & """" & url3 & """"
g_shell.Run cmdLine, 1, False

Set g_fso = Nothing
Set g_shell = Nothing
</script>
</head>
<body>
  <h3>Launching Gomega Browser...</h3>
</body>
</html>
